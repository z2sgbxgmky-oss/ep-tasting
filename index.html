<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wine Tasting Assistant</title>
    <style>
        :root {
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --burgundy: #800020;
            --flaw-bg: #fff5f5; --flaw-border: #fc8181; --flaw-text: #c53030;
            --trait-bg: #ebf8ff; --trait-border: #63b3ed; --trait-text: #2b6cb0;
            --pro-bg: #f0fff4; --pro-border: #68d391; --pro-text: #2f855a;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: #2d3748;
            margin: 0;
            padding: 10px;
            display: flex;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 850px;
            background: var(--card-bg);
            padding: 15px;
            border-radius: 12px;
            padding-bottom: 80px; 
        }

        header {
            margin-bottom: 15px;
            border-bottom: none;
            padding-bottom: 10px;
        }

        .header-row { display: flex; align-items: center; gap: 10px; }

        .sheet-dropdown {
            flex-grow: 1;
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--burgundy);
            border: none;
            background: transparent;
            padding: 5px 0;
            cursor: pointer;
        }

        .profile-dropdown {
            flex-grow: 1;
            font-size: 1.1rem; /* Increased from 0.9rem */
            font-weight: 800;  /* Increased from 700 to match header */
            color: #4a5568;    /* Darker grey for more presence */
            border: none;
            background: transparent;
            padding: 10px 0;   /* More breathing room vertically */
            cursor: pointer;
            text-transform: capitalize; /* Cleaner look */
        }

        .btn-add-sheet {
            background: transparent;
            border: 1px solid var(--burgundy);
            color: var(--burgundy);
            border-radius: 50%;
            width: 24px; height: 24px;
            font-size: 1.2rem;
            line-height: 1;
            cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            padding-bottom: 2px;
        }

        .btn-add-profile {
            background: transparent;
            border: 1px solid #718096;
            color: #718096;
            border-radius: 50%;
            width: 22px; 
            height: 22px;
            font-size: 1rem;
            line-height: 1;
            cursor: pointer;
            display: flex; 
            justify-content: center; 
            align-items: center;
            padding-bottom: 2px;
        }

        .wine-input {
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 1.1rem;
            width: 100%;
            font-weight: 600;
            color: #2d3748;
            box-sizing: border-box;
            margin-top: 5px;
        }

        /* REPORT BADGES */
        .report-badge { display: inline-block; padding: 1px 6px; margin: 0 4px 3px 0; border-radius: 4px; font-family: sans-serif; font-size: 10px; border: 1px solid transparent; }
        .badge-pro { border-color: #a5d6a7; background-color: #e8f5e9; color: #1b5e20; }
        .badge-flaw { border-color: #ef9a9a; background-color: #ffebee; color: #b71c1c; }
        .badge-trait { border-color: #90caf9; background-color: #e3f2fd; color: #0d47a1; }
        .badge-info { border-color: #bdbdbd; background-color: #f5f5f5; color: #616161; }
        .badge-neutral { border-color: #bdbdbd; background-color: #f5f5f5; color: #757575; text-decoration: line-through; }
        .report-spacer { display: block; height: 4px; }

        /* AI NOTE BOX */
        .ai-note-box {
            background: transparent;
            border: none;
            padding: 10px 0;
            margin-top: 5px;
            font-size: 0.9rem;
            color: #2d3748;
            line-height: 1.2;
            display: none;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        .ai-note-box.visible { display: block; }
        .ai-label { display: none; }


        /* BROWSER MODAL STYLES */
        .browser-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000;
            display: flex; justify-content: flex-end; /* Slides in from right */
            transition: opacity 0.2s;
        }
        .browser-overlay.hidden { display: none; opacity: 0; }

        .browser-container {
            width: 85%; max-width: 400px; height: 100%;
            background: var(--card-bg); box-shadow: -2px 0 10px rgba(0,0,0,0.2);
            display: flex; flex-direction: column;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        .browser-header {
            padding: 15px; border-bottom: 1px solid #edf2f7;
            display: flex; justify-content: space-between; align-items: center;
            background: #f8f9fa;
        }
        .browser-header h3 { margin: 0; color: #2d3748; font-size: 1.1rem; }
        .btn-close {
            background: none; border: none; font-size: 1.8rem; line-height: 1; cursor: pointer; color: #718096;
        }

        .browser-search { padding: 10px; border-bottom: 1px solid #edf2f7; }
        .browser-search input {
            width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px;
            font-size: 1rem; box-sizing: border-box; outline: none;
        }
        .browser-search input:focus { border-color: #cbd5e0; }

        .browser-list {
            flex-grow: 1; overflow-y: auto; padding: 10px;
            background: #f7fafc;
        }

        /* WINE CARD STYLE */
        .wine-card {
            background: white; border: 1px solid #e2e8f0; border-radius: 8px;
            padding: 12px; margin-bottom: 8px; cursor: pointer;
            transition: transform 0.1s, border-color 0.1s;
            border-left: 4px solid transparent;
            display: flex; flex-direction: column; gap: 4px;
        }
        .wine-card:hover { transform: translateY(-1px); border-color: #cbd5e0; }
        /* Active state highlights the card */
        .wine-card.active { border-left-color: var(--burgundy); background: #fff5f5; }

        .wc-top { display: flex; justify-content: space-between; align-items: flex-start; }
        .wc-ref { font-weight: 700; color: #2d3748; font-size: 0.95rem; }
        .wc-score { 
            background: #2d3748; color: white; padding: 2px 6px; 
            border-radius: 4px; font-weight: 700; font-size: 0.8rem; 
        }
        .wc-meta { font-size: 0.75rem; color: #718096; display: flex; justify-content: space-between; margin-top: 4px;}


        .section-header { font-size: 0.8rem; text-transform: uppercase; font-weight: 700; color: #a0aec0; border-bottom: 1px solid #edf2f7; margin: 10px 0 8px 0; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; transition: opacity 0.2s; }
        @media (max-width: 700px) { .grid-3 { grid-template-columns: 1fr; margin-bottom: 20px; } }
        
        .col { padding: 8px; border-radius: 6px; display: flex; flex-direction: column; gap: 6px; border-width: 1px; border-style: solid; }
        .col-flaws { background: var(--flaw-bg); border-color: var(--flaw-border); }
        .col-traits { background: var(--trait-bg); border-color: var(--trait-border); }
        .col-pros { background: var(--pro-bg); border-color: var(--pro-border); }
        .col-title { font-size: 0.65rem; text-transform: uppercase; font-weight: 800; opacity: 0.8; margin: 0; }
        .col-flaws .col-title { color: var(--flaw-text); }
        .col-traits .col-title { color: var(--trait-text); }
        .col-pros .col-title { color: var(--pro-text); }
        
        label { display: flex; align-items: center; font-size: 0.85rem; cursor: pointer; font-weight: 500; }
        input[type="checkbox"] { margin-right: 8px; accent-color: var(--burgundy); width: 18px; height: 18px; flex-shrink: 0; }
        
        .general-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; background: #f7fafc; padding: 8px; border-radius: 8px; border: 1px solid #edf2f7; }
        .gen-item h3 { font-size: 0.65rem; margin: 0 0 4px 0; color: #718096; text-transform: uppercase; font-weight: 700; }
        .pill-group { display: flex; flex-wrap: wrap; gap: 3px; }
        .pill-label { padding: 4px 6px; background: #e2e8f0; border-radius: 10px; font-size: 0.7rem; cursor: pointer; font-weight: 600; color: #4a5568; flex: 1; text-align: center; }
        .pill-radio { display: none; }
        .pill-radio:checked + .pill-label { background: var(--burgundy); color: white; }
        
        .comment-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; margin-top: 10px; }
        .comment-box span { font-size: 0.65rem; font-weight: 700; color: #718096; text-transform: uppercase; }
        .comment-box input { padding: 6px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 0.85rem; width: 100%; box-sizing: border-box; }
        
        .footer-control { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #ddd; display: grid; grid-template-columns: 2fr 0.8fr 0.8fr 0.8fr 0.8fr; height: 60px; z-index: 1000; }
        .ft-btn { background: white; border: none; border-left: 1px solid #eee; font-size: 1.2rem; cursor: pointer; color: #4a5568; display: flex; justify-content: center; align-items: center; font-weight: 700; padding: 0; transition: background 0.2s; }
        .ft-btn:active { background: #f7fafc; }
        .ft-btn:disabled { color: #e2e8f0; cursor: not-allowed; }
        .btn-save { background: var(--burgundy); color: white; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .btn-save.update { background: #2f855a; } 
        .btn-trash { color: #c53030; }

    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="header-row">
            <select id="sheetSelector" class="sheet-dropdown" onchange="loadSheetData()">
                <option>Loading Sheets...</option>
            </select>
            <button class="btn-add-sheet" onclick="createNewSheet()">+</button>
        </div>
        
        <input type="text" id="wineRef" class="wine-input" placeholder="Wine Name / Reference" style="margin-top:8px;">
        
        <div id="aiNoteBox" class="ai-note-box">
            <div id="aiNoteText">Generating...</div>
        </div>

        <div class="header-row" style="margin-top:25px; margin-bottom: 0px; border-bottom: 2px solid #edf2f7; padding-bottom: 5px;">
            <select id="profileSelector" class="profile-dropdown" onchange="handleProfileChange()">
                <option>Loading Profiles...</option>
            </select>
            <button class="btn-add-profile" onclick="openProfileDesigner()">+</button>
        </div>
        
    </header>


    <!-- NOSE (Dynamic Containers) -->
    <div class="section-header">Nose</div>
    <div class="grid-3" id="nose_section">
        <div class="group-box"><div class="group-label"></div><div id="container_nose_flaws"></div></div>
        <div class="group-box"><div class="group-label"></div><div id="container_nose_traits"></div></div>
        <div class="group-box"><div class="group-label"></div><div id="container_nose_pros"></div></div>
    </div>

    <!-- PALATE (Dynamic Containers) -->
    <div class="section-header">Palate</div>
    <div class="grid-3" id="palate_section">
        <div class="group-box"><div class="group-label"></div><div id="container_palate_flaws"></div></div>
        <div class="group-box"><div class="group-label"></div><div id="container_palate_traits"></div></div>
        <div class="group-box"><div class="group-label"></div><div id="container_palate_pros"></div></div>
    </div>

    <!-- FINISH (Dynamic Containers) -->
    <div class="section-header">Aftertaste</div>
    <div class="grid-3" id="finish_section">
        <div class="group-box"><div class="group-label"></div><div id="container_finish_flaws"></div></div>
        <div class="group-box"><div class="group-label"></div><div id="container_finish_traits"></div></div>
        <div class="group-box"><div class="group-label"></div><div id="container_finish_pros"></div></div>
    </div>

    <!-- GENERAL & COMMENTS -->
    <div class="general-grid" style="margin-top:20px;">
        <div class="gen-item">
            <h3>Balance</h3>
            <div class="pill-group" id="container_balance"></div>
        </div>
        <div class="gen-item">
            <h3>Profile</h3>
            <div class="pill-group" id="container_profile"></div>
        </div>
        <div class="gen-item">
            <h3>True To</h3>
            <div class="pill-group" id="container_true_to"></div>
        </div>
    </div>

    <div class="comment-grid">
        <div class="comment-box"><span>Too...</span><input type="text" id="comm_too"></div>
        <div class="comment-box"><span>Lacks...</span><input type="text" id="comm_lacks"></div>
        <div class="comment-box"><span>Remarkable...</span><input type="text" id="comm_rem"></div>
    </div>
</div>

<!-- WINE BROWSER MODAL -->
<div id="browserModal" class="browser-overlay hidden">
    <div class="browser-container">
        <div class="browser-header">
            <h3>Wine Library</h3>
            <button onclick="toggleBrowser()" class="btn-close">&times;</button>
        </div>
        
        <div class="browser-search">
            <input type="text" id="browserSearch" placeholder="Filter wines..." onkeyup="renderBrowserList()">
        </div>

        <div id="browserList" class="browser-list">
            <!-- Dynamic Content Goes Here -->
        </div>
    </div>
</div>


<div class="footer-control" style="grid-template-columns: 2fr 0.8fr 0.8fr 0.8fr 0.8fr 0.8fr;">
    <button id="saveBtn" class="ft-btn btn-save" onclick="submitData()">SAVE</button>
    <button class="ft-btn" onclick="resetForm()">+</button>
    <button class="ft-btn" onclick="toggleBrowser()" style="font-size:1.4rem;">â˜°</button> <!-- NEW LIST BUTTON -->
    <button id="prevBtn" class="ft-btn" onclick="nav(-1)">&lt;</button>
    <button id="nextBtn" class="ft-btn" onclick="nav(1)">&gt;</button>
    <button class="ft-btn btn-trash" onclick="deleteRecord()">ðŸ—‘</button>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwvhb_OSlNid4L39wJ0oiqo7tkCkhQ2U103i9V0N7r25pdJB8Ioj19YPOu2oHtR7YiU/exec";
  
    let localData = [];
    let currentIndex = -1; 
    let isUpdating = false;

    // --- 1. INITIALIZATION CHAIN ---
    // We strictly load Sheets -> Profiles -> Select First Profile -> Render.
    window.onload = function() { 
        fetchSheets(); 
        loadProfilesList(); 
    };

    function loadProfilesList() {
        fetch(`${SCRIPT_URL}?action=getProfilesList`)
        .then(r => r.json())
        .then(data => {
            const sel = document.getElementById("profileSelector");
            sel.innerHTML = "";
            
            if (data.profiles && data.profiles.length > 0) {
                data.profiles.forEach(name => {
                    let opt = document.createElement("option");
                    // Backend sends "Name (Default)" -> We display exactly that.
                    // We value exactly that. No stripping. Simple.
                    // If the wine data matches this string, good. If not, we handle it.
                    opt.value = name; 
                    opt.text = name; 
                    sel.appendChild(opt);
                });
                // Once list is populated, force load the first one.
                handleProfileChange();
            }
        });
    }

    // --- 2. PROFILE CHANGE & RENDERING ---
    function handleProfileChange() {
        const name = document.getElementById("profileSelector").value;
        if(!name) return;

        // Visual Feedback
        document.querySelectorAll('.grid-3').forEach(el => el.style.opacity = '0.4');

        fetch(`${SCRIPT_URL}?action=getProfile&name=${encodeURIComponent(name)}`)
        .then(r => r.json())
        .then(config => {
            renderProfileForm(config);
            // Once rendered, if we are viewing a wine, re-apply checks.
            if(currentIndex !== -1 && localData[currentIndex]) {
                populateCheckboxes(localData[currentIndex]);
            }
            document.querySelectorAll('.grid-3').forEach(el => el.style.opacity = '1');
        });
    }

     function renderProfileForm(config) {
        if(!config || !config.nose) return;

        // 1. Standard Checkbox Helper (for Nose/Palate/Finish)
        const mkCheck = (group, name) => `<label><input type="checkbox" name="${group}" value="${name}"> ${name}</label>`;

        // 2. Pill Radio Helper (for Profile - Single Select)
        const mkPillRadio = (group, name) => {
            const safeId = group + "_" + name.replace(/[^a-zA-Z0-9]/g, ''); 
            return `<input type="radio" name="${group}" value="${name}" id="${safeId}" class="pill-radio"><label for="${safeId}" class="pill-label">${name}</label>`;
        };

        // 3. Pill Checkbox Helper (for Balance & True To - Multi Select)
        // Re-uses the 'pill-radio' class so existing CSS (.pill-radio:checked + .pill-label) applies automatically
        const mkPillCheckbox = (group, name) => {
             const safeId = group + "_" + name.replace(/[^a-zA-Z0-9]/g, ''); 
             return `<input type="checkbox" name="${group}" value="${name}" id="${safeId}" class="pill-radio"><label for="${safeId}" class="pill-label">${name}</label>`;
        };

        // --- Render Main Sections ---
        ['nose', 'palate', 'finish'].forEach(sec => {
            ['flaws', 'traits', 'pros'].forEach(type => {
                const container = document.getElementById(`container_${sec}_${type}`);
                if(container && config[sec] && config[sec][type]) {
                    container.innerHTML = config[sec][type].map(val => mkCheck(`${sec}_${type}`, val)).join('');
                    
                    const parentBox = container.parentElement; 
                    parentBox.className = 'group-box col'; 
                    if(type === 'flaws') parentBox.classList.add('col-flaws');
                    if(type === 'traits') parentBox.classList.add('col-traits');
                    if(type === 'pros') parentBox.classList.add('col-pros');
                    
                    const title = parentBox.querySelector('.group-label');
                    if(title) {
                        // Apply the fancy style class
                        title.className = 'col-title'; 
                        // Inject the text (e.g., "Flaws")
                        title.innerText = type.charAt(0).toUpperCase() + type.slice(1);
                    }
                }
            });
        });

        // --- Render Control Panel Sections ---

        // BALANCE: Pills (Multi-Select)
        const balEl = document.getElementById('container_balance');
        if(balEl && config.balance) balEl.innerHTML = config.balance.map(v => mkPillCheckbox('balance', v)).join('');

        // PROFILE: Pills (Single-Select)
        const profEl = document.getElementById('container_profile');
        if(profEl && config.profile) profEl.innerHTML = config.profile.map(v => mkPillRadio('profile', v)).join('');

        // TRUE TO: Pills (Multi-Select)
        const trueEl = document.getElementById('container_true_to');
        if(trueEl && config.true_to) trueEl.innerHTML = config.true_to.map(v => mkPillCheckbox('true_to', v)).join('');
    }


    // --- 3. WINE DATA HANDLING ---
    function fillForm(d) {
        // 1. Fill Text
        document.getElementById('wineRef').value = d.ref || "";
        document.getElementById('comm_too').value = d.comm_too || "";
        document.getElementById('comm_lacks').value = d.comm_lacks || "";
        document.getElementById('comm_rem').value = d.comm_rem || "";

        // 2. Profile Logic
        const currentSel = document.getElementById('profileSelector');
        const wineProfile = d.profileName; // e.g. "Red Burgundy"

        // Logic: If the wine has a profile, and it is NOT what is currently selected...
        // We must switch.
        if (wineProfile && currentSel.value !== wineProfile) {
            // Check if the dropdown actually HAS this option
            let optionExists = Array.from(currentSel.options).some(o => o.value === wineProfile);
            
            if (optionExists) {
                currentSel.value = wineProfile;
                handleProfileChange(); // This will fetch, render, then populate checkboxes
            } else {
                // Edge case: Wine has a profile that isn't in the list? 
                // Just keep current, or try to fallback.
                console.warn("Profile not found in list:", wineProfile);
                populateCheckboxes(d);
            }
        } else {
            // Profile matches (or wine has none), just fill checkboxes
            populateCheckboxes(d);
        }

        // 3. AI Note Display
        const aiBox = document.getElementById('aiNoteBox');
        const aiText = document.getElementById('aiNoteText');
        let html = buildReportHtml(d.ai_note, d.scoreDisplay, d.scoreBreakdown, d.tastedDate, d.profileName);
        
        if(html) { aiText.innerHTML = html; aiBox.classList.add('visible'); } 
        else { aiBox.classList.remove('visible'); }
    }

    function populateCheckboxes(d) {
        // Clear all first
        document.querySelectorAll('input[type="checkbox"]').forEach(c => c.checked = false);
        document.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false);

        const check = (n, v) => {
            if(!v) return;
            const arr = Array.isArray(v) ? v : [v];
            arr.forEach(val => {
                const el = document.querySelector(`input[name="${n}"][value="${val}"]`);
                if(el) el.checked = true;
            });
        };

        check('nose_flaws', d.nose_flaws); check('nose_traits', d.nose_traits); check('nose_pros', d.nose_pros);
        check('palate_flaws', d.palate_flaws); check('palate_traits', d.palate_traits); check('palate_pros', d.palate_pros);
        check('finish_flaws', d.finish_flaws); check('finish_traits', d.finish_traits); check('finish_pros', d.finish_pros);
        check('true_to', d.true_to);
        if(d.balance) check('balance', d.balance);
        if(d.profile) check('profile', d.profile);
    }

    // --- 4. STANDARD UTILS (Navigation, Saving, etc.) ---
    function fetchSheets() {
        const sel = document.getElementById('sheetSelector');
        fetch(`${SCRIPT_URL}?action=getSheets`)
        .then(r => r.json())
        .then(d => {
            sel.innerHTML = "";
            d.sheets.forEach(s => {
                // Filter out sheets starting with "_" (like _CONFIG_PROFILES)
                if (s.startsWith("_")) return; 
                
                let opt = document.createElement('option');
                opt.value = s; opt.text = s;
                sel.add(opt);
            });
            const lastSheet = localStorage.getItem('lastSheet');
            if(lastSheet && d.sheets.includes(lastSheet)) sel.value = lastSheet;
            if(d.sheets.length > 0 && sel.value) loadSheetData();
        });
    }


    function createNewSheet() {
        const name = prompt("New Event Name:");
        if(!name) return;
        fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: "createSheet", newSheetName: name }) })
        .then(() => { setTimeout(() => { fetchSheets(); alert("Sheet Created!"); }, 2000); });
    }

    function loadSheetData() {
        const sheet = document.getElementById('sheetSelector').value;
        localStorage.setItem('lastSheet', sheet); 
        const btn = document.getElementById('saveBtn');
        btn.textContent = "...";
        fetch(`${SCRIPT_URL}?action=getData&sheet=${sheet}`)
        .then(r => r.json())
        .then(d => { localData = d.rows || []; resetForm(); });
    }

    function nav(dir) {
        if(localData.length === 0) return;
        if(currentIndex === -1 && dir === 1) return;
        let newIndex = (currentIndex === -1 && dir === -1) ? localData.length - 1 : currentIndex + dir;
        if (newIndex < 0) newIndex = 0;
        if (newIndex >= localData.length) newIndex = localData.length - 1;
        loadRecord(newIndex);
    }

    function loadRecord(idx) {
        currentIndex = idx;
        isUpdating = true;
        fillForm(localData[idx]);
        const btn = document.getElementById('saveBtn');
        btn.textContent = "UPDATE";
        btn.classList.add('update');
        document.getElementById('prevBtn').disabled = (idx === 0);
        document.getElementById('nextBtn').disabled = (idx === localData.length - 1);
        
        // NEW: Update button states
        updateNavButtons();
    }

    function resetForm() {
        currentIndex = -1;
        isUpdating = false;
        document.getElementById('wineRef').value = "";
        document.querySelectorAll('input[type="checkbox"]').forEach(c => c.checked = false);
        document.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false);
        document.querySelectorAll('input[type="text"]').forEach(t => t.value = "");
        const btn = document.getElementById('saveBtn');
        btn.textContent = "SAVE";
        btn.classList.remove('update');
        btn.disabled = false;
        document.getElementById('aiNoteBox').classList.remove('visible');
        
        // NEW: Disable Next button (no record to navigate to)
        document.getElementById('nextBtn').disabled = true; // Can't go forward from new
        document.getElementById('prevBtn').disabled = (localData.length === 0); // Can go back if data exists
    }


    function getChecked(n) { return Array.from(document.querySelectorAll(`input[name="${n}"]:checked`)).map(c => c.value); }
    function getRadio(n) { let el = document.querySelector(`input[name="${n}"]:checked`); return el ? el.value : ""; }

    function submitData() {
        const ref = document.getElementById('wineRef').value;
        if(!ref) { alert("Enter Wine Name"); return; }
        if (isUpdating && !confirm("Overwrite data?")) return;

        const btn = document.getElementById('saveBtn');
        btn.textContent = "GENERATING...";
        btn.disabled = true;

        const payload = {
            action: isUpdating ? "update" : "create",
            rowIndex: isUpdating ? localData[currentIndex].rowIndex : null,
            sheetName: document.getElementById('sheetSelector').value,
            profileName: document.getElementById('profileSelector').value, // This sends the CURRENT dropdown value
            ref: ref,
            nose_flaws: getChecked('nose_flaws'), nose_traits: getChecked('nose_traits'), nose_pros: getChecked('nose_pros'),
            palate_flaws: getChecked('palate_flaws'), palate_traits: getChecked('palate_traits'), palate_pros: getChecked('palate_pros'),
            finish_flaws: getChecked('finish_flaws'), finish_traits: getChecked('finish_traits'), finish_pros: getChecked('finish_pros'),
            balance: getChecked('balance'), profile: getRadio('profile'), true_to: getChecked('true_to'),
            comm_too: document.getElementById('comm_too').value,
            comm_lacks: document.getElementById('comm_lacks').value,
            comm_rem: document.getElementById('comm_rem').value
        };

        fetch(SCRIPT_URL, {
            method: 'POST', 
            headers: {'Content-Type': 'text/plain;charset=utf-8'}, 
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
            if(data.error) { alert("Error: " + data.error); btn.disabled=false; return; }
            
            // Render Result
            const aiText = document.getElementById('aiNoteText');
            aiText.innerHTML = buildReportHtml(data.ai_note, data.scoreDisplay, data.scoreBreakdown, data.tastedDate, data.profileName);
            document.getElementById('aiNoteBox').classList.add('visible');

            btn.textContent = isUpdating ? "UPDATED" : "SAVED";
            
            // Refresh Background
            const sheet = document.getElementById('sheetSelector').value;
            fetch(`${SCRIPT_URL}?action=getData&sheet=${sheet}`)
            .then(r => r.json())
            .then(d => { 
                localData = d.rows || []; 
                if(!isUpdating) currentIndex = localData.length - 1; 
                isUpdating = true;
                setTimeout(() => { btn.textContent = "UPDATE"; btn.classList.add('update'); btn.disabled = false; }, 1000);
            });
        })
        .catch(e => { alert("Save Failed"); btn.disabled=false; });
    }
    
    function deleteRecord() {
        if(!isUpdating || !confirm("Delete?")) return;
        fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ action: "delete", rowIndex: localData[currentIndex].rowIndex, sheetName: document.getElementById('sheetSelector').value })
        }).then(() => { loadSheetData(); });
    }

    function buildReportHtml(note, score, breakdown, date, profile) {
        if (!breakdown || !score) return note ? note.replace(/\n/g, '<br>') : "";
        let badgeHtml = breakdown.map(item => {
            if (item.type === 'spacer') return '<div class="report-spacer"></div>';
            if (item.type === 'break') return '<br>';
            let label = item.type === 'pro' ? item.label.replace(/ (\d+(\.\d+)?) \/ (\d+(\.\d+)?)/, ' <b>$1</b> / $3') : item.label;
            let val = (item.value !== undefined) ? ` <b>${item.value>0?"+":""}${item.value}</b>` : "";
            let style = (item.type === 'pro' && item.percent) ? `style="background: linear-gradient(90deg, #b9f6ca ${item.percent}%, #f1f8e9 ${item.percent}%);"` : "";
            return `<span class="report-badge badge-${item.type}" ${style}>${label}${val}</span>`;
        }).join('');
        return `<div style="font-family:serif; font-size:1.05em; line-height:1.5; color:#333; margin-bottom: 25px;">${note?note.replace(/\n/g, '<br>'):""}</div>
        <div style="font-family:-apple-system, sans-serif;">
            <div style="font-size:1.15em; color:#2c3e50; margin-bottom:6px; display:flex; align-items:baseline;">
                <span style="font-weight:800;">Score: ${score},</span> 
                <span style="font-weight:normal; color:#555; margin-left:6px;">${date||""}</span>
            </div>
            <div style="font-size:0.9em; line-height:1.8;">${badgeHtml}</div>
            <div style="font-size:9px; color:#ccc; margin-top:12px; text-transform:uppercase; letter-spacing:0.5px;">Profile: ${profile||"Unknown"}</div>
        </div>`;
    }

    function openProfileDesigner() {
        alert("Profile Designer (Coming Soon)");
    }


    // --- WINE BROWSER LOGIC ---

    function toggleBrowser() {
        const modal = document.getElementById('browserModal');
        const isHidden = modal.classList.contains('hidden');
        
        if (isHidden) {
            modal.classList.remove('hidden');
            renderBrowserList();
            // Auto-focus search for quick filtering
            setTimeout(() => document.getElementById('browserSearch').focus(), 100);
        } else {
            modal.classList.add('hidden');
        }
    }

    function renderBrowserList() {
        const listEl = document.getElementById('browserList');
        const filter = document.getElementById('browserSearch').value.toLowerCase();
        listEl.innerHTML = "";

        if (!localData || localData.length === 0) {
             listEl.innerHTML = `<div style="text-align:center; color:#a0aec0; margin-top:20px;">No wines in this sheet yet.</div>`;
             return;
        }

        // Iterate backwards so newest wines (bottom of sheet) appear at top of list
        // utilize localData which is already populated by loadSheetData()
        localData.slice().reverse().forEach((row, revIndex) => {
            // Calculate original index because we reversed the array
            const originalIndex = localData.length - 1 - revIndex;
            
            const ref = (row.ref || "(No Name)").toString();
            const score = row.scoreDisplay || "-";
            const profile = row.profileName || "Unknown";
            const date = row.tastedDate || "";

            // Filter Logic
            if (filter && !ref.toLowerCase().includes(filter) && !profile.toLowerCase().includes(filter)) {
                return;
            }

            const card = document.createElement('div');
            // Check if this card matches the currently loaded record
            const isActive = (currentIndex === originalIndex);
            card.className = `wine-card ${isActive ? 'active' : ''}`;
            
            card.onclick = () => {
                loadRecord(originalIndex);
                toggleBrowser(); // Close panel after selection
            };

            card.innerHTML = `
                <div class="wc-top">
                    <span class="wc-ref">${ref}</span>
                    <span class="wc-score">${score}</span>
                </div>
                <div class="wc-meta">
                    <span>${profile}</span>
                    <span>${date}</span>
                </div>
            `;
            listEl.appendChild(card);
        });

        if (listEl.innerHTML === "") {
            listEl.innerHTML = `<div style="text-align:center; color:#a0aec0; margin-top:20px;">No wines found matching "${filter}".</div>`;
        }
    }

    function updateNavButtons() {
        // Disable Previous if we are at the first record (index 0)
        document.getElementById('prevBtn').disabled = (currentIndex <= 0);
        
        // Disable Next if we are at the last record
        document.getElementById('nextBtn').disabled = (currentIndex >= localData.length - 1);
    }


</script>

</body>
</html>
